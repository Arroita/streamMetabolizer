% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/metab_Kmodel.R
\name{metab_Kmodel}
\alias{metab_Kmodel}
\title{Combine a time series of K estimates to predict unified values}
\usage{
metab_Kmodel(data = mm_data(solar.time, discharge, velocity, optional =
  c("all")), data_daily = mm_data(date, K600, K600.lower, K600.upper,
  discharge.daily, velocity.daily, optional = c("K600.lower", "K600.upper",
  "discharge.daily", "velocity.daily")), method = c("mean", "lm", "loess"),
  weights = c("CI", "CI/K600"), predictors = c("date", "velocity.daily",
  "discharge.daily"), filters = c(CI.max = NA, discharge.daily.max = NA,
  velocity.daily.max = NA), transforms = c(K600 = "log", date = NA,
  velocity.daily = "log", discharge.daily = "log"), info = NULL,
  day_start = 4, day_end = 27.99, tests = c("full_day", "even_timesteps",
  "complete_data"), ...)
}
\arguments{
\item{data}{data.frame of input data at the temporal resolution of raw 
observations. Columns must have the same names, units, and format as the 
default. See \code{\link{mm_data}} for a full data description.}

\item{data_daily}{data.frame containing inputs with a daily timestep. See 
\code{\link{mm_data}} for a full data description.}

\item{method}{the name of an interpolation or regression method relating K to
the predictor[s] of choice.}

\item{weights}{character vector indicating the type of weighting to use. 
Leave blank or set to c() for no weights.}

\item{predictors}{character vector of variables (column names in data or 
data_daily) to use in predicting K. Leave blank or set to c() for no 
predictors.}

\item{filters}{named numeric vector of limits to use in filtering data_daily.
If an element with a name in c("CI.max","discharge.daily.max","velocity.daily.max") is 
given, the corresponding filter is applied: K600.upper-K600.lower >= 
CI.max, discharge.daily <= discharge.daily.max, velocity.daily <= velocity.daily.max}

\item{transforms}{a named character vector of names of functions (probably
'log' or NA) to apply to K600 and/or the predictors. K600 should probably
be logged.}

\item{info}{any information, in any format, that you would like to store 
within the metab_model object}

\item{day_start}{start time (inclusive) of a day's data in number of hours 
from the midnight that begins the date. For example, day_start=-1.5 
indicates that data describing 2006-06-26 begin at 2006-06-25 22:30, or at 
the first observation time that occurs after that time if day_start doesn't
fall exactly on an observation time. For single days of input data, it is 
conventional/useful to begin the day the evening before, e.g., -1.5, and to
end just before the next sunrise, e.g., 30. For multiple consecutive days, 
it may make the most sense to start just before sunrise (e.g., 4) and to 
end 24 hours later. For nighttime regression to be compatible with this 
setup, the date assigned to a section of data should be the date whose 
evening contains the data. The default is therefore 12 to 36 for 
metab_night, of which the times of darkness will be used.}

\item{day_end}{end time (inclusive) of a day's data in number of hours from 
the midnight that begins the date. For example, day_end=30 indicates that 
data describing 2006-06-26 end at 2006-06-27 06:00, or at the last 
observation time that occurs before that time if day_end doesn't fall 
exactly on an observation time. See day_start for recommended start and end
times.}

\item{tests}{list of tests to conduct}

\item{...}{Other arguments passed to the fitting function given by 
\code{method}. \code{na.rm=TRUE} is already passed to \code{mean}}
}
\value{
A metab_Kmodel object containing the fitted model.
}
\description{
Takes daily estimates of K, usually from nighttime regression, and regresses 
against predictors such as discharge.daily. Returns a metab_model that only 
predicts daily K, nothing else.
}
\details{
Possible approaches:

\itemize{

\item{"mean"}{Predict K as the mean of all K values}

\item{"weighted mean"}{Predict K as the mean of all K values, weighted by the
inverse of the confidence intervals in the input K values}

\item{"KvQ"}{Regress K versus Q, tending toward overall mean in ranges of Q 
with sparse data}

\item{"weighted KvQ"}{Regress K versus Q, tending toward overall mean in 
ranges of Q with sparse data, weighting high-confidence K values more 
heavily}

\item{"T smoother"}{Predict K using a loess or spline smoother over time}

\item{"Q smoother"}{Predict K using a loess or spline smoother over 
discharge.daily}

\item{"TQ smoother"}{Predict K using a loess or spline smoother over both 
time and discharge.daily}

}
}
\examples{
\dontrun{
library(dplyr)
fr <- streamMetabolizer:::load_french_creek() \%>\% unitted::v() \%>\% 
  filter(format(solar.time, "\%Y-\%m-\%d") == "2012-08-24") \%>\% 
  select(solar.time)
fr <- fr \%>\% mutate(discharge.daily=exp(rnorm(nrow(fr))))
frk2 <- data.frame(date=seq(as.Date("2012-08-15"),as.Date("2012-09-15"),
  as.difftime(1,units='days')), discharge.daily=exp(rnorm(32,2,1)), K600=rnorm(32,30,4))
  
# 1-day tests
frk <- data.frame(date=as.Date("2012-08-24"), K600=20, stringsAsFactors=FALSE)
metab_Kmodel(data=fr, data_daily=frk, method='mean')
#metab_Kmodel(data=fr, data_daily=frk, method='lm') # NaN warning
#metab_Kmodel(data=fr, data_daily=frk, method='loess', predictors='date') # span error

# mean
mm <- metab_Kmodel(data_daily=frk2, method='mean')

# lm
mm <- metab_Kmodel(data_daily=frk2, method='lm') # very similar to mean
mm <- metab_Kmodel(data_daily=frk2, method='lm', predictors=c('discharge.daily'))
mm <- metab_Kmodel(data_daily=frk2, method='lm', predictors=c('date'))
mm <- metab_Kmodel(data_daily=frk2, method='lm', predictors=c('discharge.daily','date'))

# loess
mm <- metab_Kmodel(data_daily=frk2, method='loess', predictors='date')
mm <- metab_Kmodel(data_daily=frk2, method='loess', predictors='date', span=0.4)
mm <- metab_Kmodel(data_daily=frk2, method='loess', predictors=c('discharge.daily','date'))
mm <- metab_Kmodel(data_daily=frk2, method='loess', predictors='discharge.daily', span=2)

library(ggplot2)
ggplot(get_data_daily(mm), aes(x=date)) + geom_line(aes(y=K600)) + 
  geom_point(aes(y=K600.obs)) + geom_ribbon(aes(ymin=K600.lower, ymax=K600.upper), alpha=0.4)
}
}
\author{
Alison Appling
}
\seealso{
Other metab_model: \code{\link{metab_bayes}},
  \code{\link{metab_mle}}, \code{\link{metab_night}},
  \code{\link{metab_sim}}
}


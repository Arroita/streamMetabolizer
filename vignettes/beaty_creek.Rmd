---
title: "Metabolism in Beaty Creek, OK"
author: "Alison Appling"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Metabolism in Beaty Creek, OK}
  \usepackage[utf8]{inputenc}
---

This is an example analysis of metabolism for Beaty Creek in Oklahoma.

```{r, echo=FALSE}
# set global chunk options
knitr::opts_chunk$set(fig.width=7, fig.height=5, echo=FALSE, message=FALSE, warning=FALSE, results="hide")
```

```{r}
library(plyr)
library(dplyr)
library(dataRetrieval)
#library(sbtools)
library(mda.streams)
library(powstreams)
library(streamMetabolizer)
library(tidyr)
library(ggplot2)
library(unitted)
library(knitr)
```

```{r}
# Identify the ID for a creek from its name in NWIS
site.ids <- split_site(list_sites())
sites <- readNWISsite(site.ids) %>% select(site_no, station_nm)
beaty_creek_id <- paste0("nwis_", sites[grep("Beaty Creek near Jay, OK", sites$station_nm),"site_no"])
# Download all available timeseries data
beaty_creek <- load_timeseries(site=beaty_creek_id, variables=get_ts_variables(beaty_creek_id), join.fun=full_join)
```

Here are a few lines of the data we can pull from ScienceBase:
```{r, results="markup"}
kable(head(beaty_creek))
```

There are nearly six years of data, with pronounced seasonal patterns in DO and temperature.
```{r}
beaty_creek_tidy <- beaty_creek %>%
  rename(DO_mgL=ts_doobs, WaterTemp_C=ts_wtr) %>%
  mutate(Discharge_log_cfs=log(ts_disch)) %>%
  gather(variable, value, DO_mgL, WaterTemp_C, Discharge_log_cfs)  
# Plot to see data range and multi-year patterns
ggplot(beaty_creek_tidy, aes(x=DateTime, y=value)) + geom_point(size=0.5) + facet_grid(variable~., scales="free_y") + theme_bw()
```

Zooming in, we see well-formed diel DO cycles with observations at at half-hour intervals.
```{r}
# Zoom in to see diel cycles example
beaty_creek_tiny <- filter(beaty_creek_tidy, between(DateTime, as.POSIXct("2011-05-12 00:00:00"), as.POSIXct("2011-05-17 00:00:00")))
ggplot(beaty_creek_tiny, aes(x=DateTime, y=value)) + geom_point(size=0.5) + facet_grid(variable~., scales="free_y") + theme_bw()
```

```{r}
# Add and rename data columns as needed to pass to metab_simple
beaty_creek_may15 <- beaty_creek %>% 
  rename(DO.obs=ts_doobs) %>%
  mutate(date.time=convert_GMT_to_solartime(DateTime, longitude=site_location(beaty_creek_id)$longitude, time.type="apparent solar")) %>%
  filter(format(date.time, "%Y-%m-%d")=="2011-05-15") %>%
  mutate(doyhr=convert_date_to_doyhr(date.time)) %>%
  mutate(DO.sat=calc_DO_at_sat(temp.water=ts_wtr, pressure.air=1000),
         depth=calc_depth(Q=ts_disch*v(u(0.0283168466,"m3/s cfs^-1"))),
         k.O2=convert_k600_to_kGAS(k600=4, temperature=ts_wtr, gas="O2"), # yes, there's a legit warning for temperature out of range
         light=calc_solar_insolation(date.time, latitude=site_location(beaty_creek_id)$latitude)) %>%
  select(date.time, DO.obs, DO.sat, depth, k.O2, light)
```

Here's how the data look after munging:
```{r, results="markup"}
kable(head(beaty_creek_may15[24:48,]))
```

We'll estimate GPP and ER for just a single day, May 15, 2011, for now.
```{r, results="markup"}
# Estimate metabolism for a single day
beaty_creek_may15_metab <- metab_simple(beaty_creek_may15)
kable(predict_metab(beaty_creek_may15_metab))
beaty_creek_may15_DO <- predict_DO(beaty_creek_may15_metab)
```

Here are the observed and modeled DO concentrations. The timestamps are much better.
```{r}
# Plot the predicted and observed DO values
ggplot(gather(rename(beaty_creek_may15_DO, obs=DO.obs, mod=DO.mod), method, DO.mgL, obs, mod), aes(x=date.time, y=DO.mgL, color=method)) + geom_point() + theme_bw()
```